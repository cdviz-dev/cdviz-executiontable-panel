[tools]
"yarn" = "latest"

[tasks."install:deps"]
description = "install npm dependencies"
run = "yarn install"

[tasks.typecheck]
description = "run TypeScript type checking"
run = "yarn run typecheck"
wait_for = ["install:deps"]

[tasks.lint]
description = "lint code with eslint"
run = "yarn run lint"
wait_for = ["install:deps"]

[tasks."lint:fix"]
description = "fix lint issues and format code"
run = "yarn run lint:fix"
wait_for = ["install:deps"]

[tasks.check]
description = "typecheck + lint"
depends = ["typecheck", "lint"]

[tasks.test]
description = "run unit tests"
run = "yarn run test:ci"
wait_for = ["install:deps"]

[tasks.build]
description = "build plugin for production"
run = "yarn run build"
sources = ["src/**", "package.json", "tsconfig.json"]
outputs = ["dist/*"]
wait_for = ["install:deps"]

[tasks.dev]
description = "start webpack in watch mode + grafana dev server"
run = [
  "docker compose up -d",
  "yarn run dev",
]
wait_for = ["install:deps"]

[tasks."dev:server"]
description = "start only the grafana dev server (docker compose)"
run = "docker compose up"
wait_for = ["install:deps"]

[tasks."dev:server:stop"]
description = "stop the grafana dev server"
run = "docker compose down"

[tasks."dev:server:restart"]
description = "restart the grafana dev server"
run = "docker compose restart grafana"

[tasks.e2e]
description = "run end-to-end tests with Playwright"
run = "yarn run e2e"
wait_for = ["install:deps"]

[tasks.sign]
description = "sign plugin for distribution"
run = "yarn run sign"
wait_for = ["build"]

[tasks.package]
description = "build and package plugin as zip for distribution"
run = [
  """
  #!/usr/bin/env bash
  set -euo pipefail
  plugin_id=$(yarn node -e "console.log(require('./src/plugin.json').id)")
  dist_dir="dist"
  out="${plugin_id}-$(yarn node -e "console.log(require('./package.json').version)").zip"
  cd "$dist_dir" && zip -r "../$out" . && cd ..
  echo "Packaged: $out"
  """,
]
depends = ["build"]

[tasks.ci]
description = "full CI pipeline: install, check, test, build"
depends = ["install:deps", "check", "test", "build"]

[tasks.version]
description = "set version in package.json, plugin.json, create git tag and push"
usage = """
flag "--version <version>" help="Version number to set (e.g., 1.0.3)"
"""
run = [
  """
  #!/usr/bin/env bash
  set -euo pipefail

  echo "Setting version to $usage_version"

  # Update package.json
  echo "Updating package.json..."
  yarn node -e "
    const fs = require('fs');
    const pkg = require('./package.json');
    pkg.version = '$usage_version';
    fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\\n');
  "

  # Update src/plugin.json
  echo "Updating src/plugin.json..."
  yarn node -e "
    const fs = require('fs');
    const plugin = require('./src/plugin.json');
    plugin.info.version = '$usage_version';
    fs.writeFileSync('./src/plugin.json', JSON.stringify(plugin, null, 2) + '\\n');
  "

  echo "Version updated to $usage_version in package.json and src/plugin.json"

  # Commit the version changes
  echo "Committing version changes..."
  git add package.json src/plugin.json
  git commit -m "chore: bump version to $usage_version"

  # Create git tag
  TAG="v$usage_version"
  echo "Creating git tag $TAG..."
  git tag -a "$TAG" -m "$usage_version"

  echo "Pushing to origin with tags..."
  git push origin main --follow-tags

  echo "âœ“ Version $usage_version released and pushed!"
  """,
]
wait_for = ["install:deps"]
